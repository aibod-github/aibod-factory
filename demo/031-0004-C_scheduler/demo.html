<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Scheduler Demo | AIBOD Factory</title>
    <meta name="description" content="Orders-only production scheduler - No master data required">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Language Switcher */
        .lang-switch {
            position: absolute;
            top: 15px;
            right: 20px;
            display: flex;
            gap: 5px;
        }

        .lang-btn {
            padding: 5px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .lang-btn:hover, .lang-btn.active {
            background: rgba(255,255,255,0.3);
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            position: relative;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-top: 10px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 20px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 20px;
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title .icon {
            font-size: 1.2rem;
        }

        /* Input Form */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #555;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 220px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.82rem;
            line-height: 1.5;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* Config Section */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }

        .summary-card .label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        /* Gantt Chart */
        .gantt-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        .gantt-chart {
            min-width: 100%;
            border-collapse: collapse;
        }

        .gantt-header {
            background: #f8f9fa;
            position: sticky;
            top: 0;
        }

        .gantt-header th {
            padding: 10px 5px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #dee2e6;
            min-width: 50px;
        }

        .gantt-header th.product-col {
            min-width: 120px;
            text-align: left;
            padding-left: 15px;
        }

        .gantt-row {
            border-bottom: 1px solid #eee;
        }

        .gantt-row:hover {
            background: #f8f9fa;
        }

        .gantt-row td {
            padding: 8px 2px;
            vertical-align: middle;
            position: relative;
        }

        .gantt-row td.product-cell {
            padding-left: 15px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .gantt-bar {
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 2px;
        }

        .gantt-bar:hover {
            transform: scale(1.08);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }

        /* Product Colors */
        .product-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .product-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .product-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .product-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .product-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .product-6 { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
        .product-7 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .product-8 { background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); }

        /* Timeline View */
        .timeline-view {
            margin-top: 15px;
        }

        .timeline-day {
            margin-bottom: 20px;
        }

        .timeline-day-header {
            font-weight: 600;
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .timeline-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
        }

        .timeline-slot {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }

        .timeline-slot .time {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .timeline-slot .product {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .timeline-slot .quantity {
            font-size: 0.85rem;
            color: #888;
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        /* Status Messages */
        .status {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .status-error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .status-success {
            background: #dcfce7;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .status-loading {
            background: #e0e7ff;
            color: #4f46e5;
            border: 1px solid #c7d2fe;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        .tab {
            padding: 8px 16px;
            border: none;
            background: none;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            color: #666;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        /* JSON Output */
        .json-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.8rem;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .json-key { color: #9cdcfe; }
        .json-string { color: #ce9178; }
        .json-number { color: #b5cea8; }

        /* Footer */
        footer {
            text-align: center;
            padding: 30px 20px;
            color: #888;
            font-size: 0.85rem;
        }

        footer a {
            color: #667eea;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Info Box */
        .info-box {
            background: #e0e7ff;
            border: 1px solid #c7d2fe;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #4338ca;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="lang-switch">
                <button class="lang-btn" data-lang="en" onclick="setLang('en')">EN</button>
                <button class="lang-btn active" data-lang="ja" onclick="setLang('ja')">JA</button>
            </div>
            <h1>üìÖ <span data-i18n="title">Simple Scheduler</span></h1>
            <p data-i18n="subtitle">Orders-only scheduling - No master data required</p>
            <span class="badge">‚ú® <span data-i18n="badge">100% Client-side - No server needed</span></span>
        </header>

        <div class="main-grid">
            <!-- Input Panel -->
            <div class="panel">
                <h2 class="panel-title"><span class="icon">üìù</span> <span data-i18n="input_orders">Input Orders</span></h2>

                <div class="info-box">
                    <strong data-i18n="info_title">How it works:</strong>
                    <span data-i18n="info_desc">Enter orders with product ID, quantity, and due dates. The scheduler splits orders into lot-sized job units and assigns time slots.</span>
                </div>

                <div class="form-group">
                    <label data-i18n="orders_json">Orders (JSON)</label>
                    <textarea id="ordersInput"></textarea>
                </div>

                <div class="panel-title" style="margin-top: 20px;"><span class="icon">‚öôÔ∏è</span> <span data-i18n="configuration">Configuration</span></div>
                <div class="config-grid">
                    <div class="form-group">
                        <label data-i18n="lot_size">Lot Size</label>
                        <input type="number" id="lotSize" value="40" min="1">
                    </div>
                    <div class="form-group">
                        <label data-i18n="planning_days">Planning Days</label>
                        <input type="number" id="planningDays" value="7" min="1">
                    </div>
                    <div class="form-group">
                        <label data-i18n="working_hours">Working Hours/Day</label>
                        <input type="number" id="workingHours" value="8" min="1" max="24">
                    </div>
                    <div class="form-group">
                        <label data-i18n="start_datetime">Start DateTime</label>
                        <input type="datetime-local" id="startDateTime">
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" id="runScheduler" onclick="runScheduler()">
                        ‚ñ∂Ô∏è <span data-i18n="run_scheduler">Run Scheduler</span>
                    </button>
                    <button class="btn btn-secondary" onclick="loadSampleData()">
                        üìã <span data-i18n="sample_data">Sample Data</span>
                    </button>
                    <button class="btn btn-secondary" onclick="clearAll()">
                        üóëÔ∏è <span data-i18n="clear">Clear</span>
                    </button>
                </div>

                <div id="statusMessage" style="margin-top: 15px;"></div>
            </div>

            <!-- Results Panel -->
            <div class="panel">
                <h2 class="panel-title"><span class="icon">üìä</span> <span data-i18n="schedule_results">Schedule Results</span></h2>

                <div id="resultsContainer">
                    <div class="empty-state">
                        <div class="icon">üìã</div>
                        <p data-i18n="empty_state">Run the scheduler to see results</p>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>
                <strong>Simple Scheduler</strong> by <a href="https://aibod-github.github.io/aibod-factory/" target="_blank">AIBOD Factory</a>
            </p>
            <p data-i18n="footer_desc">A lightweight production scheduler that only requires orders data. No complex master data setup needed.</p>
        </footer>
    </div>

    <script>
        // ==================== Internationalization ====================
        const i18n = {
            en: {
                title: "Simple Scheduler",
                subtitle: "Orders-only scheduling - No master data required",
                badge: "100% Client-side - No server needed",
                input_orders: "Input Orders",
                info_title: "How it works:",
                info_desc: "Enter orders with product ID, quantity, and due dates. The scheduler splits orders into lot-sized job units and assigns time slots.",
                orders_json: "Orders (JSON)",
                configuration: "Configuration",
                lot_size: "Lot Size",
                planning_days: "Planning Days",
                working_hours: "Working Hours/Day",
                start_datetime: "Start DateTime",
                run_scheduler: "Run Scheduler",
                sample_data: "Sample Data",
                clear: "Clear",
                schedule_results: "Schedule Results",
                empty_state: "Run the scheduler to see results",
                footer_desc: "A lightweight production scheduler that only requires orders data. No complex master data setup needed.",
                orders: "Orders",
                job_units: "Job Units",
                time: "Time",
                gantt_chart: "Gantt Chart",
                timeline: "Timeline",
                json: "JSON",
                product: "Product",
                running: "Running scheduler...",
                success: "Scheduled {0} job units in {1}s",
                error_json: "Invalid JSON format",
                error_no_orders: "No orders provided",
                units: "units"
            },
            ja: {
                title: "„Ç∑„É≥„Éó„É´ „Çπ„Ç±„Ç∏„É•„Éº„É©",
                subtitle: "„Ç™„Éº„ÉÄ„Éº„ÅÆ„Åø„ÅßÁ®ºÂÉç - „Éû„Çπ„Çø„Éá„Éº„Çø‰∏çË¶Å",
                badge: "100% „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅ¥ - „Çµ„Éº„Éê„Éº‰∏çË¶Å",
                input_orders: "„Ç™„Éº„ÉÄ„ÉºÂÖ•Âäõ",
                info_title: "‰Ωø„ÅÑÊñπ:",
                info_desc: "Ë£ΩÂìÅID„ÄÅÊï∞Èáè„ÄÅÁ¥çÊúü„ÇíÂê´„ÇÄ„Ç™„Éº„ÉÄ„Éº„ÇíÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇ„Çπ„Ç±„Ç∏„É•„Éº„É©„Åå„Ç™„Éº„ÉÄ„Éº„Çí„É≠„ÉÉ„Éà„Çµ„Ç§„Ç∫„ÅÆ„Ç∏„Éß„Éñ„É¶„Éã„ÉÉ„Éà„Å´ÂàÜÂâ≤„Åó„ÄÅ„Çø„Ç§„É†„Çπ„É≠„ÉÉ„Éà„ÇíÂâ≤„ÇäÂΩì„Å¶„Åæ„Åô„ÄÇ",
                orders_json: "„Ç™„Éº„ÉÄ„Éº (JSON)",
                configuration: "Ë®≠ÂÆö",
                lot_size: "„É≠„ÉÉ„Éà„Çµ„Ç§„Ç∫",
                planning_days: "Ë®àÁîªÊó•Êï∞",
                working_hours: "Á®ºÂÉçÊôÇÈñì/Êó•",
                start_datetime: "ÈñãÂßãÊó•ÊôÇ",
                run_scheduler: "„Çπ„Ç±„Ç∏„É•„Éº„É´ÂÆüË°å",
                sample_data: "„Çµ„É≥„Éó„É´„Éá„Éº„Çø",
                clear: "„ÇØ„É™„Ç¢",
                schedule_results: "„Çπ„Ç±„Ç∏„É•„Éº„É´ÁµêÊûú",
                empty_state: "„Çπ„Ç±„Ç∏„É•„Éº„É©„ÇíÂÆüË°å„Åó„Å¶ÁµêÊûú„ÇíË°®Á§∫",
                footer_desc: "„Ç™„Éº„ÉÄ„Éº„Éá„Éº„Çø„ÅÆ„Åø„ÅßÂãï‰Ωú„Åô„ÇãËªΩÈáè„Å™ÁîüÁî£„Çπ„Ç±„Ç∏„É•„Éº„É©„ÄÇË§áÈõë„Å™„Éû„Çπ„Çø„Éá„Éº„ÇøË®≠ÂÆö„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇ",
                orders: "„Ç™„Éº„ÉÄ„Éº",
                job_units: "„Ç∏„Éß„Éñ„É¶„Éã„ÉÉ„Éà",
                time: "Âá¶ÁêÜÊôÇÈñì",
                gantt_chart: "„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà",
                timeline: "„Çø„Ç§„É†„É©„Ç§„É≥",
                json: "JSON",
                product: "Ë£ΩÂìÅ",
                running: "„Çπ„Ç±„Ç∏„É•„Éº„É´ÂÆüË°å‰∏≠...",
                success: "{0} „Ç∏„Éß„Éñ„É¶„Éã„ÉÉ„Éà„Çí {1}Áßí „ÅßÁîüÊàê",
                error_json: "JSONÂΩ¢Âºè„Åå‰∏çÊ≠£„Åß„Åô",
                error_no_orders: "„Ç™„Éº„ÉÄ„Éº„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì",
                units: "ÂÄã"
            }
        };

        let currentLang = 'ja';

        function setLang(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (i18n[lang][key]) {
                    el.textContent = i18n[lang][key];
                }
            });
            // Update sample data with new language
            loadSampleData();
        }

        function t(key, ...args) {
            let text = i18n[currentLang][key] || i18n['en'][key] || key;
            args.forEach((arg, i) => {
                text = text.replace(`{${i}}`, arg);
            });
            return text;
        }

        // ==================== Date Helpers ====================
        function getDateStr(daysFromNow) {
            const d = new Date();
            d.setDate(d.getDate() + daysFromNow);
            return d.toISOString().split('T')[0];
        }

        function formatDate(date) {
            const d = new Date(date);
            return `${d.getMonth() + 1}/${d.getDate()}`;
        }

        function formatTime(date) {
            const d = new Date(date);
            return `${d.getHours().toString().padStart(2, '0')}:00`;
        }

        // ==================== Initialization ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Set default start datetime
            const now = new Date();
            now.setMinutes(0, 0, 0);
            document.getElementById('startDateTime').value = now.toISOString().slice(0, 16);

            // Check URL params for language
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            if (langParam && (langParam === 'en' || langParam === 'ja')) {
                setLang(langParam);
            } else {
                setLang('ja');
            }
        });

        // ==================== Sample Data ====================
        function loadSampleData() {
            const productNames = currentLang === 'ja'
                ? ["Ë£ΩÂìÅ A", "Ë£ΩÂìÅ B", "Ë£ΩÂìÅ C", "Ë£ΩÂìÅ A"]
                : ["Product A", "Product B", "Product C", "Product A"];

            const sampleOrders = [
                {
                    id: 1,
                    mst_product: 1,
                    product_name: productNames[0],
                    first_due_datetime: getDateStr(1) + "T08:00:00",
                    last_due_datetime: getDateStr(3) + "T17:00:00",
                    quantity: 120
                },
                {
                    id: 2,
                    mst_product: 2,
                    product_name: productNames[1],
                    first_due_datetime: getDateStr(2) + "T08:00:00",
                    last_due_datetime: getDateStr(4) + "T17:00:00",
                    quantity: 80
                },
                {
                    id: 3,
                    mst_product: 3,
                    product_name: productNames[2],
                    first_due_datetime: getDateStr(1) + "T14:00:00",
                    last_due_datetime: getDateStr(2) + "T17:00:00",
                    quantity: 40
                },
                {
                    id: 4,
                    mst_product: 1,
                    product_name: productNames[3],
                    first_due_datetime: getDateStr(3) + "T08:00:00",
                    last_due_datetime: getDateStr(5) + "T17:00:00",
                    quantity: 60
                }
            ];
            document.getElementById('ordersInput').value = JSON.stringify(sampleOrders, null, 2);
        }

        function clearAll() {
            document.getElementById('ordersInput').value = '';
            document.getElementById('resultsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="icon">üìã</div>
                    <p data-i18n="empty_state">${t('empty_state')}</p>
                </div>
            `;
            document.getElementById('statusMessage').innerHTML = '';
        }

        // ==================== Scheduler Logic ====================
        function runScheduler() {
            const btn = document.getElementById('runScheduler');
            const statusDiv = document.getElementById('statusMessage');

            btn.disabled = true;
            statusDiv.innerHTML = `<div class="status status-loading">‚è≥ ${t('running')}</div>`;

            // Use setTimeout to allow UI to update
            setTimeout(() => {
                try {
                    const startTime = performance.now();

                    // Parse orders
                    const ordersText = document.getElementById('ordersInput').value.trim();
                    if (!ordersText) {
                        throw new Error(t('error_no_orders'));
                    }

                    let orders;
                    try {
                        orders = JSON.parse(ordersText);
                    } catch (e) {
                        throw new Error(t('error_json'));
                    }

                    if (!Array.isArray(orders) || orders.length === 0) {
                        throw new Error(t('error_no_orders'));
                    }

                    // Get config
                    const config = {
                        lot_size: parseInt(document.getElementById('lotSize').value) || 40,
                        planning_days: parseInt(document.getElementById('planningDays').value) || 7,
                        working_hours_per_day: parseInt(document.getElementById('workingHours').value) || 8,
                        start_datetime: document.getElementById('startDateTime').value
                    };

                    // Run scheduling
                    const result = schedule(orders, config);

                    const elapsedTime = ((performance.now() - startTime) / 1000).toFixed(3);
                    result.summary.elapsed_time = parseFloat(elapsedTime);

                    statusDiv.innerHTML = `<div class="status status-success">‚úÖ ${t('success', result.summary.total_job_units, elapsedTime)}</div>`;
                    renderResults(result);

                } catch (error) {
                    statusDiv.innerHTML = `<div class="status status-error">‚ùå ${error.message}</div>`;
                } finally {
                    btn.disabled = false;
                }
            }, 50);
        }

        function schedule(orders, config) {
            const lotSize = config.lot_size;
            const planningDays = config.planning_days;
            const workingHours = config.working_hours_per_day;

            let startDateTime = config.start_datetime
                ? new Date(config.start_datetime)
                : new Date();
            startDateTime.setMinutes(0, 0, 0);

            const endDateTime = new Date(startDateTime);
            endDateTime.setDate(endDateTime.getDate() + planningDays);

            // Filter and sort orders by due date
            const filteredOrders = orders
                .filter(o => {
                    const lastDue = new Date(o.last_due_datetime);
                    return lastDue <= endDateTime;
                })
                .sort((a, b) => new Date(a.first_due_datetime) - new Date(b.first_due_datetime));

            // Create job units from orders
            const jobUnits = [];
            let priority = 0;

            for (const order of filteredOrders) {
                const totalLots = Math.ceil(order.quantity / lotSize);

                for (let i = 0; i < totalLots; i++) {
                    const remaining = order.quantity - (i * lotSize);
                    const lotQuantity = Math.min(lotSize, remaining);

                    jobUnits.push({
                        mst_product: order.mst_product,
                        product_name: order.product_name || `Product ${order.mst_product}`,
                        quantity: lotQuantity,
                        first_due_datetime: order.first_due_datetime,
                        last_due_datetime: order.last_due_datetime,
                        priority: priority++
                    });
                }
            }

            // Assign time slots
            let currentSlot = new Date(startDateTime);
            let dailyHoursUsed = 0;
            let currentDay = currentSlot.toDateString();
            const startHour = currentSlot.getHours();

            for (const ju of jobUnits) {
                // Move to next day if daily hours exhausted
                if (dailyHoursUsed >= workingHours) {
                    currentSlot.setDate(currentSlot.getDate() + 1);
                    currentSlot.setHours(startHour, 0, 0, 0);
                    dailyHoursUsed = 0;
                    currentDay = currentSlot.toDateString();
                }

                ju.planned_start_timestamp = new Date(currentSlot).toISOString();
                currentSlot.setHours(currentSlot.getHours() + 1);
                ju.planned_end_timestamp = new Date(currentSlot).toISOString();

                dailyHoursUsed++;

                // Check day rollover
                if (currentSlot.toDateString() !== currentDay) {
                    currentDay = currentSlot.toDateString();
                    dailyHoursUsed = 0;
                }
            }

            return {
                status: 'success',
                job_units: jobUnits,
                summary: {
                    total_orders: orders.length,
                    total_job_units: jobUnits.length,
                    elapsed_time: 0
                }
            };
        }

        // ==================== Rendering ====================
        function renderResults(result) {
            const container = document.getElementById('resultsContainer');
            const jobUnits = result.job_units;

            if (!jobUnits || jobUnits.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="icon">üì≠</div><p>${t('empty_state')}</p></div>`;
                return;
            }

            // Get unique products
            const products = [...new Set(jobUnits.map(ju => ju.mst_product))];
            const productNames = {};
            jobUnits.forEach(ju => {
                productNames[ju.mst_product] = ju.product_name || `${t('product')} ${ju.mst_product}`;
            });

            // Group by day
            const days = {};
            jobUnits.forEach(ju => {
                const date = new Date(ju.planned_start_timestamp).toDateString();
                if (!days[date]) days[date] = [];
                days[date].push(ju);
            });

            // Build HTML
            let html = `
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="value">${result.summary.total_orders}</div>
                        <div class="label">${t('orders')}</div>
                    </div>
                    <div class="summary-card">
                        <div class="value">${result.summary.total_job_units}</div>
                        <div class="label">${t('job_units')}</div>
                    </div>
                    <div class="summary-card">
                        <div class="value">${result.summary.elapsed_time}s</div>
                        <div class="label">${t('time')}</div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('gantt')">üìä ${t('gantt_chart')}</button>
                    <button class="tab" onclick="switchTab('timeline')">üìÖ ${t('timeline')}</button>
                    <button class="tab" onclick="switchTab('json')">{ } ${t('json')}</button>
                </div>

                <div id="gantt" class="tab-content active">
                    ${renderGanttChart(jobUnits, days, products, productNames)}
                </div>

                <div id="timeline" class="tab-content">
                    ${renderTimeline(days, productNames)}
                </div>

                <div id="json" class="tab-content">
                    <div class="json-output">${syntaxHighlight(JSON.stringify(result, null, 2))}</div>
                </div>

                <div class="legend">
                    ${products.map((p, i) => `
                        <div class="legend-item">
                            <div class="legend-color product-${(p % 8) || 8}"></div>
                            <span>${productNames[p]}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        function renderGanttChart(jobUnits, days, products, productNames) {
            const dayKeys = Object.keys(days).sort((a, b) => new Date(a) - new Date(b));

            // Get hours range
            let minHour = 24, maxHour = 0;
            jobUnits.forEach(ju => {
                const start = new Date(ju.planned_start_timestamp).getHours();
                const end = new Date(ju.planned_end_timestamp).getHours();
                minHour = Math.min(minHour, start);
                maxHour = Math.max(maxHour, end || 24);
            });

            const hours = [];
            for (let h = minHour; h < maxHour; h++) {
                hours.push(h);
            }

            let html = '<div class="gantt-container"><table class="gantt-chart">';

            // Header
            html += `<thead class="gantt-header"><tr><th class="product-col">${t('product')}</th>`;
            dayKeys.forEach(day => {
                hours.forEach(h => {
                    html += `<th>${formatDate(day)}<br>${h}:00</th>`;
                });
            });
            html += '</tr></thead>';

            // Rows per product
            html += '<tbody>';
            products.forEach(productId => {
                html += `<tr class="gantt-row">`;
                html += `<td class="product-cell">${productNames[productId]}</td>`;

                dayKeys.forEach(day => {
                    hours.forEach(hour => {
                        const ju = jobUnits.find(j => {
                            const jDate = new Date(j.planned_start_timestamp);
                            return j.mst_product === productId &&
                                   jDate.toDateString() === day &&
                                   jDate.getHours() === hour;
                        });

                        if (ju) {
                            html += `<td>
                                <div class="gantt-bar product-${(productId % 8) || 8}"
                                     title="${productNames[productId]}: ${ju.quantity} ${t('units')}">
                                    ${ju.quantity}
                                </div>
                            </td>`;
                        } else {
                            html += '<td></td>';
                        }
                    });
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';

            return html;
        }

        function renderTimeline(days, productNames) {
            const dayKeys = Object.keys(days).sort((a, b) => new Date(a) - new Date(b));

            let html = '<div class="timeline-view">';

            dayKeys.forEach(day => {
                const d = new Date(day);
                const dateStr = d.toLocaleDateString(currentLang === 'ja' ? 'ja-JP' : 'en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });

                html += `<div class="timeline-day">`;
                html += `<div class="timeline-day-header">üìÖ ${dateStr}</div>`;
                html += `<div class="timeline-slots">`;

                days[day]
                    .sort((a, b) => new Date(a.planned_start_timestamp) - new Date(b.planned_start_timestamp))
                    .forEach(ju => {
                        const startTime = new Date(ju.planned_start_timestamp);
                        const endTime = new Date(ju.planned_end_timestamp);
                        const timeStr = `${formatTime(startTime)} - ${formatTime(endTime)}`;

                        html += `
                            <div class="timeline-slot" style="border-left-color: var(--product-color);">
                                <div class="time">üïê ${timeStr}</div>
                                <div class="product">${productNames[ju.mst_product]}</div>
                                <div class="quantity">üì¶ ${ju.quantity} ${t('units')}</div>
                            </div>
                        `;
                    });

                html += '</div></div>';
            });

            html += '</div>';
            return html;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        function syntaxHighlight(json) {
            return json
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
                    function (match) {
                        let cls = 'json-number';
                        if (/^"/.test(match)) {
                            cls = /:$/.test(match) ? 'json-key' : 'json-string';
                        }
                        return '<span class="' + cls + '">' + match + '</span>';
                    });
        }
    </script>
</body>
</html>
